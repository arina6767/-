from aiogram import Bot, Dispatcher, executor, types
import random

TOKEN = "8564961413:AAFNCBFsA-iloUx"

bot = Bot(token=TOKEN)
dp = Dispatcher(bot)

# -----------------------------
# –î–ê–ù–ù–´–ï
# -----------------------------

bonus_codes = [
    "LIT2S9KGJH9",
    "LIT2Sbmkjh",
    "CLASSIC35vx52p",
    "promokodi30j",
    "PROKACHAYSYA",
    "LIT2Srvmg9z",
    "FIRE"
]

# 5 —Å—Ç—Ä–∞–Ω √ó 4 —Å—Ñ–µ—Ä—ã √ó 4 –Ω–∞–ª–æ–≥–∞ (0/2/5/8)
tax_data = {
    "–ò—Ç–∞–ª–∏—è": {
        "–¢—É—Ä–∏–∑–º": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–ª–∞–≥–∞ –ò—Ç–∞–ª–∏–∏ –≤ –¥–µ–∫–æ—Ä–µ": 0,
            "–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –∑–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ": 2,
            "–°–±–æ—Ä –∑–∞ –≤—Ö–æ–¥ –≤ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ä–∞–π–æ–Ω—ã": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞": 8
        },
        "–≠–∫–æ–ª–æ–≥–∏—è": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —Å—Ç–∞–∫–∞–Ω—á–∏–∫–∏": 0,
            "–°–±–æ—Ä –∑–∞ –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ –±—É—Ç—ã–ª–∫–∏": 2,
            "–°–±–æ—Ä –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É –æ—Ç—Ö–æ–¥–æ–≤": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—ä–µ–∑–¥ –∞–≤—Ç–æ –≤ —Ü–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞": 8
        },
        "–ú–µ–¥–∏—Ü–∏–Ω–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–æ–∫—É–ø–∫—É –≤–∏—Ç–∞–º–∏–Ω–æ–≤ —Ç—É—Ä–∏—Å—Ç–∞–º–∏": 0,
            "–°–±–æ—Ä –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–µ—Å—Ç–Ω—ã—Ö –∫–ª–∏–Ω–∏–∫": 2,
            "–°–±–æ—Ä –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π": 5,
            "–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –º–µ–¥—Å–±–æ—Ä –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤": 8
        },
        "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —É–ª–∏—á–Ω—ã—Ö –º—É–∑—ã–∫–∞–Ω—Ç–æ–≤": 0,
            "–°–±–æ—Ä –∑–∞ —Ç–æ—Ä–≥–æ–≤–ª—é –≤ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –±–∏–∑–Ω–µ—Å –≤ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ä–∞–π–æ–Ω–∞—Ö": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤": 8
        }
    },

    "–Ø–ø–æ–Ω–∏—è": {
        "–¢—É—Ä–∏–∑–º": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Ñ–æ—Ç–æ –≤ –º–µ—Ç—Ä–æ": 0,
            "–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –≤ –æ—Ç–µ–ª—è—Ö": 2,
            "–°–±–æ—Ä –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Ö—Ä–∞–º–æ–≤": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∑–æ–Ω": 8
        },
        "–≠–∫–æ–ª–æ–≥–∏—è": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã": 0,
            "–°–±–æ—Ä –∑–∞ —É–ø–∞–∫–æ–≤–∫—É": 2,
            "–°–±–æ—Ä –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏": 8
        },
        "–ú–µ–¥–∏—Ü–∏–Ω–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–æ—Å—Ç–∏": 0,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏": 2,
            "–°–±–æ—Ä –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—Ä–µ–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã": 8
        },
        "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–æ–∑–¥–Ω–∏–µ –ø—Ä–æ–≥—É–ª–∫–∏": 0,
            "–°–±–æ—Ä –∑–∞ —à—É–º –Ω–æ—á—å—é": 2,
            "–°–±–æ—Ä —Å –∫–æ–º–ø–∞–Ω–∏–π –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏": 5,
            "–ù–∞–ª–æ–≥ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Ç—Ä—É–¥–∞ –∏ –æ—Ç–¥—ã—Ö–∞": 8
        }
    },

    "–°–®–ê": {
        "–¢—É—Ä–∏–∑–º": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–µ–ª—Ñ–∏ –≤ –ø–∞—Ä–∫–µ": 0,
            "–°–±–æ—Ä –∑–∞ –ø–∞—Ä–∫–æ–≤–∫—É —É –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π": 2,
            "–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –≤ –æ—Ç–µ–ª—è—Ö": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∫–æ–≤": 8
        },
        "–≠–∫–æ–ª–æ–≥–∏—è": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ —Ç—Ä—É–±–æ—á–∫–∏": 0,
            "–°–±–æ—Ä –∑–∞ –≤—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—ã–±—Ä–æ—Å—ã –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π": 5,
            "–£–≥–ª–µ—Ä–æ–¥–Ω—ã–π –Ω–∞–ª–æ–≥": 8
        },
        "–ú–µ–¥–∏—Ü–∏–Ω–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Ñ–∞—Å—Ç—Ñ—É–¥": 0,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏": 2,
            "–°–±–æ—Ä –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –æ–∂–∏—Ä–µ–Ω–∏—è": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ —É–ª—å—Ç—Ä–∞–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é –ø–∏—â—É": 8
        },
        "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Ä–µ–∫–ª–∞–º—É": 0,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–æ—Ü—Å–µ—Ç–∏": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø—É—Å—Ç—É—é—â–µ–µ –∂–∏–ª—å—ë": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ø–µ–∫—É–ª—è—Ü–∏—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å—é": 8
        }
    },

    "–§—Ä–∞–Ω—Ü–∏—è": {
        "–¢—É—Ä–∏–∑–º": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª–∏—Ü": 0,
            "–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –∑–∞ –º—É–∑–µ–∏": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ –≤ –æ—Ç–µ–ª—è—Ö": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –∞–≤–∏–∞–ø–µ—Ä–µ–ª—ë—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω—ã": 8
        },
        "–≠–∫–æ–ª–æ–≥–∏—è": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã": 0,
            "–°–±–æ—Ä –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É –æ—Ç—Ö–æ–¥–æ–≤": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—ä–µ–∑–¥ –∞–≤—Ç–æ –≤ —Ü–µ–Ω—Ç—Ä": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –≤–æ–∑–¥—É—Ö–∞": 8
        },
        "–ú–µ–¥–∏—Ü–∏–Ω–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–æ—Å—Ç–∏": 0,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏": 2,
            "–°–±–æ—Ä –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—Ä–µ–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã": 8
        },
        "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –º–æ–¥–Ω—É—é –æ–¥–µ–∂–¥—É": 0,
            "–°–±–æ—Ä –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –±–∏–∑–Ω–µ—Å –≤ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ä–∞–π–æ–Ω–∞—Ö": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø—É—Å—Ç—É—é—â–µ–µ –∂–∏–ª—å—ë": 8
        }
    },

    "–ö–∏—Ç–∞–π": {
        "–¢—É—Ä–∏–∑–º": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Ñ–æ—Ç–æ —Ç—É—Ä–∏—Å—Ç–æ–≤": 0,
            "–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä": 2,
            "–°–±–æ—Ä –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–æ–Ω": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –º–∞—Å—Å–æ–≤—ã–µ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã": 8
        },
        "–≠–∫–æ–ª–æ–≥–∏—è": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —É–ø–∞–∫–æ–≤–∫—É": 0,
            "–°–±–æ—Ä –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É –æ—Ç—Ö–æ–¥–æ–≤": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—ã–±—Ä–æ—Å—ã –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ": 8
        },
        "–ú–µ–¥–∏—Ü–∏–Ω–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–æ—Å—Ç–∏": 0,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏": 2,
            "–°–±–æ—Ä –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—Ä–µ–¥–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏": 8
        },
        "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –Ω–æ—á–Ω—ã–µ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è": 0,
            "–°–±–æ—Ä –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ –≤ –≥–æ—Ä–æ–¥–µ": 2,
            "–°–±–æ—Ä –∑–∞ –ø–µ—Ä–µ–Ω–∞—Å–µ–ª—ë–Ω–Ω–æ—Å—Ç—å –º–µ–≥–∞–ø–æ–ª–∏—Å–∞": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–µ—Ä–µ–≥—Ä—É–∑ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã": 8
        }
    }
}

# -----------------------------
# –ü–ê–ú–Ø–¢–¨ –ò–ì–†–û–ö–ê
# -----------------------------

user_scores = {}         # uid -> score
user_state = {}          # uid -> {"country":..., "sector":...}
user_bonus_given = {}    # uid -> True/False

# –ê–Ω—Ç–∏—Ñ–∞—Ä–º: —á—Ç–æ —É–∂–µ –∑–∞—Å—á–∏—Ç–∞–Ω–æ
# uid -> set(("–ò—Ç–∞–ª–∏—è","–¢—É—Ä–∏–∑–º","–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–ª–æ–≥–∞"), ...)
user_done = {}

# -----------------------------
# –ö–ù–û–ü–ö–ò
# -----------------------------

def main_menu_keyboard():
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("–ò—Ç–∞–ª–∏—è", "–Ø–ø–æ–Ω–∏—è")
    kb.add("–°–®–ê", "–§—Ä–∞–Ω—Ü–∏—è", "–ö–∏—Ç–∞–π")
    kb.add("üìä –ú–æ–∏ –±–∞–ª–ª—ã", "üéÅ –ü–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å")
    return kb

def sectors_keyboard():
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("–¢—É—Ä–∏–∑–º", "–≠–∫–æ–ª–æ–≥–∏—è")
    kb.add("–ú–µ–¥–∏—Ü–∏–Ω–∞", "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞")
    kb.add("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—Ä–∞–Ω–∞–º")
    return kb

def taxes_keyboard(country, sector):
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)

    taxes = list(tax_data[country][sector].keys())
    random.shuffle(taxes)

    kb.add(taxes[0], taxes[1])
    kb.add(taxes[2], taxes[3])
    kb.add("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ñ–µ—Ä–∞–º")
    return kb

# -----------------------------
# –•–≠–õ–ü–ï–†–´
# -----------------------------

def get_score(uid):
    return user_scores.get(uid, 0)

def add_score(uid, points):
    user_scores[uid] = get_score(uid) + points

def ensure_user(uid):
    if uid not in user_scores:
        user_scores[uid] = 0
    if uid not in user_state:
        user_state[uid] = {}
    if uid not in user_bonus_given:
        user_bonus_given[uid] = False
    if uid not in user_done:
        user_done[uid] = set()

# -----------------------------
# –•–≠–ù–î–õ–ï–†–´
# -----------------------------

@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    uid = message.from_user.id
    ensure_user(uid)

    user_scores[uid] = 0
    user_state[uid] = {}
    user_bonus_given[uid] = False
    user_done[uid] = set()

    await message.answer(
        "üåç *–ò–≥—Ä–∞ ¬´–ù–µ–æ–±—ã—á–Ω—ã–µ –Ω–∞–ª–æ–≥–∏ –º–∏—Ä–∞¬ª*\n\n"
        "–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Å—Ç—ã–µ:\n"
        "1) –í—ã–±–∏—Ä–∞–µ—à—å —Å—Ç—Ä–∞–Ω—É\n"
        "2) –í—ã–±–∏—Ä–∞–µ—à—å —Å—Ñ–µ—Ä—É\n"
        "3) –í—ã–±–∏—Ä–∞–µ—à—å –Ω–∞–ª–æ–≥\n\n"
        "üí° –ó–∞ –∫–∞–∂–¥—ã–π –≤—ã–±–æ—Ä –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –±–∞–ª–ª—ã:\n"
        "0 / 2 / 5 / 8\n\n"
        "‚ö†Ô∏è –ê–Ω—Ç–∏—Ñ–∞—Ä–º –≤–∫–ª—é—á—ë–Ω: –æ–¥–∏–Ω –Ω–∞–ª–æ–≥ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑.\n\n"
        "üéÅ –ù–∞–±–µ—Ä–∏ *50 –±–∞–ª–ª–æ–≤* –∏ –∑–∞–±–µ—Ä–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –∫–Ω–æ–ø–∫–æ–π ¬´–ü–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å¬ª.",
        parse_mode="Markdown",
        reply_markup=main_menu_keyboard()
    )

@dp.message_handler(lambda m: m.text == "üìä –ú–æ–∏ –±–∞–ª–ª—ã")
async def my_score(message: types.Message):
    uid = message.from_user.id
    ensure_user(uid)

    await message.answer(
        f"üìä –í–∞—à–∏ –±–∞–ª–ª—ã: *{get_score(uid)}*",
        parse_mode="Markdown",
        reply_markup=main_menu_keyboard()
    )

@dp.message_handler(lambda m: m.text == "üéÅ –ü–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å")
async def get_bonus(message: types.Message):
    uid = message.from_user.id
    ensure_user(uid)

    score = get_score(uid)

    if score < 50:
        await message.answer(
            f"üéÅ –î–æ –±–æ–Ω—É—Å–∞ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç: *{50 - score}* –±–∞–ª–ª–æ–≤.\n"
            "–ü—Ä–æ–¥–æ–ª–∂–∞–π –∏–≥—Ä–∞—Ç—å üòà",
            parse_mode="Markdown",
            reply_markup=main_menu_keyboard()
        )
        return

    if user_bonus_given.get(uid, False):
        await message.answer(
            "üéÅ –í—ã —É–∂–µ –ø–æ–ª—É—á–∞–ª–∏ –±–æ–Ω—É—Å.\n"
            "–ë–æ–Ω—É—Å –≤—ã–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ üëå",
            reply_markup=main_menu_keyboard()
        )
        return

    code = random.choice(bonus_codes)
    user_bonus_given[uid] = True

    await message.answer(
        "üéâ *–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!*\n"
        "–í—ã –Ω–∞–±—Ä–∞–ª–∏ 50 –±–∞–ª–ª–æ–≤.\n\n"
        f"–í–∞—à –ø—Ä–æ–º–æ–∫–æ–¥: `{code}`\n\n"
        "‚ö†Ô∏è –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏–∑ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ –º–æ–≥—É—Ç –ø–µ—Ä–µ—Å—Ç–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å.",
        parse_mode="Markdown",
        reply_markup=main_menu_keyboard()
    )

@dp.message_handler(lambda m: m.text in tax_data.keys())
async def choose_sector(message: types.Message):
    uid = message.from_user.id
    ensure_user(uid)

    user_state[uid] = {"country": message.text}

    await message.answer(
        f"üåç –°—Ç—Ä–∞–Ω–∞: *{message.text}*\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ñ–µ—Ä—É:",
        parse_mode="Markdown",
        reply_markup=sectors_keyboard()
    )

@dp.message_handler(lambda m: m.text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—Ä–∞–Ω–∞–º")
async def back_to_countries(message: types.Message):
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É:", reply_markup=main_menu_keyboard())

@dp.message_handler(lambda m: m.text in ["–¢—É—Ä–∏–∑–º", "–≠–∫–æ–ª–æ–≥–∏—è", "–ú–µ–¥–∏—Ü–∏–Ω–∞", "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞"])
async def choose_tax(message: types.Message):
    uid = message.from_user.id
    ensure_user(uid)

    if "country" not in user_state[uid]:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É.", reply_markup=main_menu_keyboard())
        return

    user_state[uid]["sector"] = message.text

    country = user_state[uid]["country"]
    sector = user_state[uid]["sector"]

    await message.answer(
        f"üìå *{country}* ‚Üí *{sector}*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ª–æ–≥:",
        parse_mode="Markdown",
        reply_markup=taxes_keyboard(country, sector)
    )

@dp.message_handler(lambda m: m.text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ñ–µ—Ä–∞–º")
async def back_to_sectors(message: types.Message):
    uid = message.from_user.id
    ensure_user(uid)

    if "country" not in user_state[uid]:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É.", reply_markup=main_menu_keyboard())
        return

    await message.answer(
        f"üåç –°—Ç—Ä–∞–Ω–∞: *{user_state[uid]['country']}*\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ñ–µ—Ä—É:",
        parse_mode="Markdown",
        reply_markup=sectors_keyboard()
    )

@dp.message_handler(lambda m: True)
async def handle_tax(message: types.Message):
    uid = message.from_user.id
    ensure_user(uid)

    if "country" not in user_state[uid] or "sector" not in user_state[uid]:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –∏ —Å—Ñ–µ—Ä—É.", reply_markup=main_menu_keyboard())
        return

    country = user_state[uid]["country"]
    sector = user_state[uid]["sector"]

    # –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–µ –Ω–∞–ª–æ–≥, –∞ —á—Ç–æ-—Ç–æ –¥—Ä—É–≥–æ–µ
    if message.text not in tax_data[country][sector]:
        await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ª–æ–≥ —Å –∫–Ω–æ–ø–æ–∫.", reply_markup=taxes_keyboard(country, sector))
        return

    tax_name = message.text

    # –ê–Ω—Ç–∏—Ñ–∞—Ä–º: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É–∂–µ –∑–∞—Å—á–∏—Ç–∞–Ω —ç—Ç–æ—Ç –Ω–∞–ª–æ–≥
    key = (country, sector, tax_name)
    if key in user_done[uid]:
        await message.answer(
            "‚ö†Ô∏è –≠—Ç–æ—Ç –Ω–∞–ª–æ–≥ —É–∂–µ –±—ã–ª –∑–∞—Å—á–∏—Ç–∞–Ω.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π üòä",
            reply_markup=taxes_keyboard(country, sector)
        )
        return

    # –ó–∞—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞–ª–æ–≥
    user_done[uid].add(key)

    points = tax_data[country][sector][tax_name]
    add_score(uid, points)

    total = get_score(uid)

    await message.answer(
        f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏:\n"
        f"üåç {country}\n"
        f"üìå {sector}\n"
        f"üí° {tax_name}\n\n"
        f"üéØ –ë–∞–ª–ª—ã: *{points}*\n"
        f"üìä –í—Å–µ–≥–æ: *{total}*\n\n"
        f"üéÅ –î–æ –±–æ–Ω—É—Å–∞: *{max(0, 50-total)}*",
        parse_mode="Markdown",
        reply_markup=main_menu_keyboard()
    )


if __name__ == "__main__":
    executor.start_polling(dp)
