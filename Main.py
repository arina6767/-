import random
import asyncio
from aiogram import Bot, Dispatcher, F
from aiogram.types import Message, ReplyKeyboardMarkup, KeyboardButton
from aiogram.filters import Command

# =========================
#  –¢–û–ö–ï–ù
# =========================

TOKEN = "8564961413:AAFNCBFsA-iloUx"


# =========================
#  –î–ê–ù–ù–´–ï –ò–ì–†–´
# =========================

tax_data = {
    "–ò—Ç–∞–ª–∏—è": {
        "–¢—É—Ä–∏–∑–º": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–ª–∞–≥–∞ –ò—Ç–∞–ª–∏–∏ –≤ –¥–µ–∫–æ—Ä–µ": 0,
            "–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –∑–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ": 2,
            "–°–±–æ—Ä –∑–∞ –≤—Ö–æ–¥ –≤ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ä–∞–π–æ–Ω—ã": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞": 8
        },
        "–≠–∫–æ–ª–æ–≥–∏—è": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ —Å—Ç–∞–∫–∞–Ω—á–∏–∫–∏": 0,
            "–°–±–æ—Ä –∑–∞ –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ –±—É—Ç—ã–ª–∫–∏": 2,
            "–°–±–æ—Ä –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É –æ—Ç—Ö–æ–¥–æ–≤": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—ä–µ–∑–¥ –∞–≤—Ç–æ –≤ —Ü–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞": 8
        },
        "–ú–µ–¥–∏—Ü–∏–Ω–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–æ–∫—É–ø–∫—É –≤–∏—Ç–∞–º–∏–Ω–æ–≤ —Ç—É—Ä–∏—Å—Ç–∞–º–∏": 0,
            "–°–±–æ—Ä –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–µ—Å—Ç–Ω—ã—Ö –∫–ª–∏–Ω–∏–∫": 2,
            "–°–±–æ—Ä –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π": 5,
            "–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –º–µ–¥—Å–±–æ—Ä –¥–ª—è —Ç—É—Ä–∏—Å—Ç–æ–≤": 8
        },
        "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —É–ª–∏—á–Ω—ã—Ö –º—É–∑—ã–∫–∞–Ω—Ç–æ–≤": 0,
            "–°–±–æ—Ä –∑–∞ —Ç–æ—Ä–≥–æ–≤–ª—é –≤ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –±–∏–∑–Ω–µ—Å –≤ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ä–∞–π–æ–Ω–∞—Ö": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤": 8
        }
    },

    "–Ø–ø–æ–Ω–∏—è": {
        "–¢—É—Ä–∏–∑–º": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Ñ–æ—Ç–æ –≤ –º–µ—Ç—Ä–æ": 0,
            "–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –≤ –æ—Ç–µ–ª—è—Ö": 2,
            "–°–±–æ—Ä –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Ö—Ä–∞–º–æ–≤": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∑–æ–Ω": 8
        },
        "–≠–∫–æ–ª–æ–≥–∏—è": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã": 0,
            "–°–±–æ—Ä –∑–∞ —É–ø–∞–∫–æ–≤–∫—É": 2,
            "–°–±–æ—Ä –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏": 8
        },
        "–ú–µ–¥–∏—Ü–∏–Ω–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–æ—Å—Ç–∏": 0,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏": 2,
            "–°–±–æ—Ä –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—Ä–µ–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã": 8
        },
        "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–æ–∑–¥–Ω–∏–µ –ø—Ä–æ–≥—É–ª–∫–∏": 0,
            "–°–±–æ—Ä –∑–∞ —à—É–º –Ω–æ—á—å—é": 2,
            "–°–±–æ—Ä —Å –∫–æ–º–ø–∞–Ω–∏–π –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏": 5,
            "–ù–∞–ª–æ–≥ –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Ç—Ä—É–¥–∞ –∏ –æ—Ç–¥—ã—Ö–∞": 8
        }
    },

    "–°–®–ê": {
        "–¢—É—Ä–∏–∑–º": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–µ–ª—Ñ–∏ –≤ –ø–∞—Ä–∫–µ": 0,
            "–°–±–æ—Ä –∑–∞ –ø–∞—Ä–∫–æ–≤–∫—É —É –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π": 2,
            "–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –≤ –æ—Ç–µ–ª—è—Ö": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∫–æ–≤": 8
        },
        "–≠–∫–æ–ª–æ–≥–∏—è": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ —Ç—Ä—É–±–æ—á–∫–∏": 0,
            "–°–±–æ—Ä –∑–∞ –≤—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—ã–±—Ä–æ—Å—ã –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π": 5,
            "–£–≥–ª–µ—Ä–æ–¥–Ω—ã–π –Ω–∞–ª–æ–≥": 8
        },
        "–ú–µ–¥–∏—Ü–∏–Ω–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Ñ–∞—Å—Ç—Ñ—É–¥": 0,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏": 2,
            "–°–±–æ—Ä –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –æ–∂–∏—Ä–µ–Ω–∏—è": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ —É–ª—å—Ç—Ä–∞–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é –ø–∏—â—É": 8
        },
        "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Ä–µ–∫–ª–∞–º—É": 0,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–æ—Ü—Å–µ—Ç–∏": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø—É—Å—Ç—É—é—â–µ–µ –∂–∏–ª—å—ë": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ø–µ–∫—É–ª—è—Ü–∏—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å—é": 8
        }
    },

    "–§—Ä–∞–Ω—Ü–∏—è": {
        "–¢—É—Ä–∏–∑–º": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞–Ω–∏–µ —É–ª–∏—Ü": 0,
            "–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –∑–∞ –º—É–∑–µ–∏": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ –≤ –æ—Ç–µ–ª—è—Ö": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –∞–≤–∏–∞–ø–µ—Ä–µ–ª—ë—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–∞–Ω—ã": 8
        },
        "–≠–∫–æ–ª–æ–≥–∏—è": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–ª–∞—Å—Ç–∏–∫–æ–≤—ã–µ –ø–∞–∫–µ—Ç—ã": 0,
            "–°–±–æ—Ä –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É –æ—Ç—Ö–æ–¥–æ–≤": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—ä–µ–∑–¥ –∞–≤—Ç–æ –≤ —Ü–µ–Ω—Ç—Ä": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –≤–æ–∑–¥—É—Ö–∞": 8
        },
        "–ú–µ–¥–∏—Ü–∏–Ω–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–æ—Å—Ç–∏": 0,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏": 2,
            "–°–±–æ—Ä –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—Ä–µ–¥–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã": 8
        },
        "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –º–æ–¥–Ω—É—é –æ–¥–µ–∂–¥—É": 0,
            "–°–±–æ—Ä –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –±–∏–∑–Ω–µ—Å –≤ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ä–∞–π–æ–Ω–∞—Ö": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø—É—Å—Ç—É—é—â–µ–µ –∂–∏–ª—å—ë": 8
        }
    },

    "–ö–∏—Ç–∞–π": {
        "–¢—É—Ä–∏–∑–º": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Ñ–æ—Ç–æ —Ç—É—Ä–∏—Å—Ç–æ–≤": 0,
            "–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä": 2,
            "–°–±–æ—Ä –∑–∞ –ø–æ—Å–µ—â–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –∑–æ–Ω": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –º–∞—Å—Å–æ–≤—ã–µ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã": 8
        },
        "–≠–∫–æ–ª–æ–≥–∏—è": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —É–ø–∞–∫–æ–≤–∫—É": 0,
            "–°–±–æ—Ä –∑–∞ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫—É –æ—Ç—Ö–æ–¥–æ–≤": 2,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—ã–±—Ä–æ—Å—ã –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ": 8
        },
        "–ú–µ–¥–∏—Ü–∏–Ω–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–æ—Å—Ç–∏": 0,
            "–ù–∞–ª–æ–≥ –Ω–∞ —Å–ª–∞–¥–∫–∏–µ –Ω–∞–ø–∏—Ç–∫–∏": 2,
            "–°–±–æ—Ä –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫—É –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –≤—Ä–µ–¥–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏": 8
        },
        "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞": {
            "–ù–∞–ª–æ–≥ –Ω–∞ –Ω–æ—á–Ω—ã–µ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è": 0,
            "–°–±–æ—Ä –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ –≤ –≥–æ—Ä–æ–¥–µ": 2,
            "–°–±–æ—Ä –∑–∞ –ø–µ—Ä–µ–Ω–∞—Å–µ–ª—ë–Ω–Ω–æ—Å—Ç—å –º–µ–≥–∞–ø–æ–ª–∏—Å–∞": 5,
            "–ù–∞–ª–æ–≥ –Ω–∞ –ø–µ—Ä–µ–≥—Ä—É–∑ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã": 8
        }
    }
}

bonus_codes = [
    "LIT2S9KGJH9",
    "LIT2Sbmkjh",
    "CLASSIC35vx52p",
    "promokodi30j",
    "PROKACHAYSYA"
]

BONUS_THRESHOLD = 50  # —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –±–∞–ª–ª–æ–≤ –¥–ª—è –±–æ–Ω—É—Å–æ–≤


# =========================
#  –ü–ê–ú–Ø–¢–¨ –ò–ì–†–û–ö–û–í
# =========================

user_scores = {}        # uid -> int
user_state = {}         # uid -> {"country": "...", "sector": "..."}
user_used_taxes = {}    # uid -> set( (country, sector, tax_name) )


# =========================
#  –ö–õ–ê–í–ò–ê–¢–£–†–´
# =========================

def countries_keyboard():
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–ò—Ç–∞–ª–∏—è"), KeyboardButton(text="–Ø–ø–æ–Ω–∏—è")],
            [KeyboardButton(text="–°–®–ê"), KeyboardButton(text="–§—Ä–∞–Ω—Ü–∏—è"), KeyboardButton(text="–ö–∏—Ç–∞–π")],
            [KeyboardButton(text="üìä –ú–æ–∏ –±–∞–ª–ª—ã")]
        ],
        resize_keyboard=True
    )
    return kb


def sectors_keyboard():
    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="–¢—É—Ä–∏–∑–º"), KeyboardButton(text="–≠–∫–æ–ª–æ–≥–∏—è")],
            [KeyboardButton(text="–ú–µ–¥–∏—Ü–∏–Ω–∞"), KeyboardButton(text="–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞")],
            [KeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—Ä–∞–Ω–∞–º")]
        ],
        resize_keyboard=True
    )
    return kb


def taxes_keyboard(country, sector):
    taxes = list(tax_data[country][sector].keys())
    random.shuffle(taxes)

    kb = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text=taxes[0]), KeyboardButton(text=taxes[1])],
            [KeyboardButton(text=taxes[2]), KeyboardButton(text=taxes[3])],
            [KeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ñ–µ—Ä–∞–º")]
        ],
        resize_keyboard=True
    )
    return kb


# =========================
#  –£–¢–ò–õ–ò–¢–ê: –°–ö–û–õ–¨–ö–û –î–û –ë–û–ù–£–°–û–í
# =========================

def bonus_progress_text(total_score: int) -> str:
    if total_score >= BONUS_THRESHOLD:
        return "üéÅ –ë–æ–Ω—É—Å—ã —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã!"
    left = BONUS_THRESHOLD - total_score
    return f"‚è≥ –î–æ –±–æ–Ω—É—Å–æ–≤ –æ—Å—Ç–∞–ª–æ—Å—å: {left} –±–∞–ª–ª–æ–≤"


# =========================
#  –ë–û–¢
# =========================

bot = Bot(token=TOKEN)
dp = Dispatcher()


@dp.message(Command("start"))
async def start(message: Message):
    uid = message.from_user.id

    user_scores[uid] = 0
    user_state[uid] = {}
    user_used_taxes[uid] = set()

    await message.answer(
        "üåç –ò–≥—Ä–∞ ¬´–ù–µ–æ–±—ã—á–Ω—ã–µ –Ω–∞–ª–æ–≥–∏ –º–∏—Ä–∞¬ª!\n\n"
        "üëâ –í—ã–±–∏—Ä–∞–π: —Å—Ç—Ä–∞–Ω–∞ ‚Üí —Å—Ñ–µ—Ä–∞ ‚Üí –Ω–∞–ª–æ–≥.\n\n"
        f"{bonus_progress_text(0)}",
        reply_markup=countries_keyboard()
    )


@dp.message(F.text == "üìä –ú–æ–∏ –±–∞–ª–ª—ã")
async def my_score(message: Message):
    uid = message.from_user.id
    score = user_scores.get(uid, 0)

    await message.answer(
        f"üìä –í–∞—à–∏ –±–∞–ª–ª—ã: {score}\n{bonus_progress_text(score)}",
        reply_markup=countries_keyboard()
    )


@dp.message(F.text.in_(tax_data.keys()))
async def choose_sector(message: Message):
    uid = message.from_user.id

    user_state.setdefault(uid, {})
    user_state[uid]["country"] = message.text
    user_state[uid].pop("sector", None)

    await message.answer(
        f"‚úÖ –°—Ç—Ä–∞–Ω–∞ –≤—ã–±—Ä–∞–Ω–∞: {message.text}\n\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ñ–µ—Ä—É:",
        reply_markup=sectors_keyboard()
    )


@dp.message(F.text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ç—Ä–∞–Ω–∞–º")
async def back_to_countries(message: Message):
    uid = message.from_user.id
    user_state.setdefault(uid, {})
    user_state[uid] = {}

    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É:",
        reply_markup=countries_keyboard()
    )


@dp.message(F.text.in_(["–¢—É—Ä–∏–∑–º", "–≠–∫–æ–ª–æ–≥–∏—è", "–ú–µ–¥–∏—Ü–∏–Ω–∞", "–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞"]))
async def choose_tax(message: Message):
    uid = message.from_user.id

    if uid not in user_state or "country" not in user_state[uid]:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É.", reply_markup=countries_keyboard())
        return

    user_state[uid]["sector"] = message.text

    country = user_state[uid]["country"]
    sector = user_state[uid]["sector"]

    await message.answer(
        f"‚úÖ –°—Ñ–µ—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞: {sector}\n\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ª–æ–≥:",
        reply_markup=taxes_keyboard(country, sector)
    )


@dp.message(F.text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å—Ñ–µ—Ä–∞–º")
async def back_to_sectors(message: Message):
    uid = message.from_user.id

    if uid not in user_state or "country" not in user_state[uid]:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É.", reply_markup=countries_keyboard())
        return

    user_state[uid].pop("sector", None)

    await message.answer(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ñ–µ—Ä—É:",
        reply_markup=sectors_keyboard()
    )


@dp.message()
async def handle_tax(message: Message):
    uid = message.from_user.id

    if uid not in user_state or "country" not in user_state[uid] or "sector" not in user_state[uid]:
        await message.answer("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É –∏ —Å—Ñ–µ—Ä—É.", reply_markup=countries_keyboard())
        return

    country = user_state[uid]["country"]
    sector = user_state[uid]["sector"]

    if message.text not in tax_data[country][sector]:
        await message.answer(
            "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ª–æ–≥ —Å –∫–Ω–æ–ø–æ–∫ üôÇ",
            reply_markup=taxes_keyboard(country, sector)
        )
        return

    tax_name = message.text
    points = tax_data[country][sector][tax_name]

    # =========================
    # –ê–ù–¢–ò–§–ê–†–ú
    # =========================
    key = (country, sector, tax_name)
    user_used_taxes.setdefault(uid, set())

    if key in user_used_taxes[uid]:
        await message.answer(
            "‚õî –≠—Ç–æ—Ç –Ω–∞–ª–æ–≥ —É–∂–µ –±—ã–ª –≤—ã–±—Ä–∞–Ω —Ä–∞–Ω—å—à–µ.\n"
            "–ë–∞–ª–ª—ã –∑–∞ –Ω–µ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è üôÇ\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –Ω–∞–ª–æ–≥:",
            reply_markup=taxes_keyboard(country, sector)
        )
        return

    user_used_taxes[uid].add(key)

    # –Ω–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã
    user_scores.setdefault(uid, 0)
    user_scores[uid] += points
    total = user_scores[uid]

    text = (
        f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏:\n"
        f"üåç {country} ‚Üí {sector}\n"
        f"üßæ {tax_name}\n\n"
        f"üéØ –ë–∞–ª–ª—ã –∑–∞ –Ω–∞–ª–æ–≥: {points}\n"
        f"üìä –í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤: {total}\n"
        f"{bonus_progress_text(total)}"
    )

    if total >= BONUS_THRESHOLD:
        text += "\n\nüéÅ –ë–æ–Ω—É—Å-–∫–æ–¥—ã:\n" + "\n".join(bonus_codes)

    await message.answer(text, reply_markup=countries_keyboard())


# =========================
#  –ó–ê–ü–£–°–ö
# =========================

async def main():
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
